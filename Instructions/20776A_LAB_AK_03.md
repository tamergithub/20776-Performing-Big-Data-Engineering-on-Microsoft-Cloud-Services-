# Module 3: Performing Custom Processing in Azure Stream Analytics

- [Module 3: Performing Custom Processing in Azure Stream Analytics](#module-3-performing-custom-processing-in-azure-stream-analytics)
  - [Lab: Performing custom processing with Stream Analytics](#lab-performing-custom-processing-with-stream-analytics)
  - [Exercise 1: Use a Stream Analytics UDF function to identify specific data points](#exercise-1-use-a-stream-analytics-udf-function-to-identify-specific-data-points)
    - [Task 1: Update the event hub and add a consumer group](#task-1-update-the-event-hub-and-add-a-consumer-group)
    - [Task 2: Add a queue to the Service Bus namespace](#task-2-add-a-queue-to-the-service-bus-namespace)
    - [Task 3: Configure the Location Alerts app](#task-3-configure-the-location-alerts-app)
    - [Task 4: Reconfigure the TrafficAnalytics Stream Analytics job](#task-4-reconfigure-the-trafficanalytics-stream-analytics-job)
    - [Task 5: Start the Stream Analytics jobs](#task-5-start-the-stream-analytics-jobs)
    - [Task 6: Start the Speed Camera app](#task-6-start-the-speed-camera-app)
    - [Task 7: Start the Patrol Car app](#task-7-start-the-patrol-car-app)
    - [Task 8: Start the Location Alerts app](#task-8-start-the-location-alerts-app)
    - [Task 9: View the results](#task-9-view-the-results)
    - [Task 10: Close jobs and apps](#task-10-close-jobs-and-apps)
  - [Exercise 2: Use a Stream Analytics UDF to identify duplicate data records](#exercise-2-use-a-stream-analytics-udf-to-identify-duplicate-data-records)
    - [Task 1: Update the event hub and add a consumer group](#task-1-update-the-event-hub-and-add-a-consumer-group)
    - [Task 2: Create and configure a new Stream Analytics job](#task-2-create-and-configure-a-new-stream-analytics-job)
    - [Task 3: Start the Speed Camera app](#task-3-start-the-speed-camera-app)
    - [Task 4: Examine the generated data](#task-4-examine-the-generated-data)
    - [Task 5: Close jobs and apps](#task-5-close-jobs-and-apps)
  - [Exercise 3: Use Machine Learning with Stream Analytics to identify data anomalies](#exercise-3-use-machine-learning-with-stream-analytics-to-identify-data-anomalies)
    - [Task 1: Update the event hub and add another consumer group](#task-1-update-the-event-hub-and-add-another-consumer-group)
    - [Task 2: Create and configure a new Stream Analytics job](#task-2-create-and-configure-a-new-stream-analytics-job)
    - [Task 3: Configure and start the Speed Camera app](#task-3-configure-and-start-the-speed-camera-app)
    - [Task 4: Stop the Speed Camera app and the CaptureTrafficData Stream Analytics job](#task-4-stop-the-speed-camera-app-and-the-capturetrafficdata-stream-analytics-job)
    - [Task 5: Download the training data](#task-5-download-the-training-data)
    - [Task 6: Create a Machine Learning workspace](#task-6-create-a-machine-learning-workspace)
    - [Task 7: Create a machine learning experiment](#task-7-create-a-machine-learning-experiment)
    - [Task 8: Create a trained model](#task-8-create-a-trained-model)
    - [Task 9: Expose the trained model as a web service](#task-9-expose-the-trained-model-as-a-web-service)
    - [Task 10: Add another consumer group to the Speed Camera event hub](#task-10-add-another-consumer-group-to-the-speed-camera-event-hub)
    - [Task 11: Create a new Service Bus queue](#task-11-create-a-new-service-bus-queue)
    - [Task 12: Create and Configure a new Stream Analytics job](#task-12-create-and-configure-a-new-stream-analytics-job)
    - [Task 13: Start the Stream Analytics jobs](#task-13-start-the-stream-analytics-jobs)
    - [Task 14l: Configure the Location Alerts app](#task-14l-configure-the-location-alerts-app)
    - [Task 15: Start the Patrol Car and Speed Camera apps](#task-15-start-the-patrol-car-and-speed-camera-apps)
    - [Task 16: Start the Location Alerts app and view the results](#task-16-start-the-location-alerts-app-and-view-the-results)
    - [Task 17: Lab closedown](#task-17-lab-closedown)

## Lab: Performing custom processing with Stream Analytics

> **Important**: Due to the CPU-intensive nature of some of the tasks performed by the applications in this lab, it is recommended that you assign at least 4 virtual processors to the 20776A-LON-DEV VM before starting this lab. To do this, perform the following steps:
>   1. Shutdown the 20776A-LON-DEV VM if it is currently running
>   2. Using Hyper-V Manager, right-click the 20776A-LON-DEV VM, and then click **Settings**
>   3. Click **Processor**
>   4. In the **Processor** pane, increase **Number of virtual processors** to 4
>   5. Click **OK**
>   6. Restart the 20776A-LON-DEV VM

## Exercise 1: Use a Stream Analytics UDF function to identify specific data points

### Task 1: Update the event hub and add a consumer group

1. Click **All resources**, and then click **camerafeeds&lt;_your name_&gt;&lt;_date_&gt;**.
2. On the **camerafeeds&lt;_your name_&gt;&lt;_date_&gt;** blade, under **Entities**, click **Event Hubs**, and then click **traffic**.
3. On the **traffic** blade, click **+ Consumer Group**.
4. On the **Create consumer group** blade, in the **Name** box, type **cameradatafeed3**, and then click **Create**.

### Task 2: Add a queue to the Service Bus namespace

1. Click **All resources**, and then click **locationalerts&lt;_your name_&gt;&lt;_date_&gt;**.
2. On the **locationalerts&lt;_your name_&gt;&lt;_date_&gt;** blade, under **Entities**, click **Queues**, and then click **+ Queue**.
3. On the **Create queue** blade, in the **Name** box, type **SpeedCameraAlerts**.
4. Leave all other settings at their defaults, and click **Create**.
5. Wait until the queue has been successfully created before continuing with the lab.
6. On the **locationalerts&lt;_your name_&gt;&lt;_date_&gt;** blade, click **Shared Access Policies**, and then click **RootManageAccessKey**.
7. In the **SAS Policy: RootManageSharedAccessKey** blade, copy the value in the **Primary Key** column to the clipboard.
8. On the Windows desktop, start **Notepad**, and paste the primary key into the new Notepad file.
9. On the **File** menu, click **Save As**, and save the file as **Config\_details.txt** in the **E:\\Labfiles\\Lab03** folder. Leave Notepad open.

### Task 3: Configure the Location Alerts app

1. On the Windows **Start** menu, type **Visual Studio 2017**, and then press Enter.
2. On the **File** menu, point to **Open**, and then click **Project/Solution**.
3. In the **Open Project** dialog box, go to the **E:\\Labfiles\\Lab03\\LocationAlerts** folder, click **LocationAlerts.sln**, and then click **Open**.
4. In Solution Explorer, double-click **ConfigSettings.txt**.
5. In ConfigSettings.txt, replace the text **YourServiceBusName** with **locationalerts&lt;_your name_&gt;&lt;_date_&gt;**.
6. In the same file, replace the text **YourPrimaryKey** with the SharedAccessKey for the Service Bus namespace that you copied to the **Config\_details.txt** file using Notepad in Task 2.
7. On the **Build** menu, click **Build Solution**. Verify that the app compiles successfully, but do not start the app.
8. On the **Build** menu, click **Deploy LocationAlerts**.
9. In the **Microsoft Visual Studio** dialog box, click **Yes** to overwrite the existing installation.

### Task 4: Reconfigure the TrafficAnalytics Stream Analytics job

1. Return to the Azure portal.
2. Click **All resources**, and then click **TrafficAnalytics**.
3. On the **TrafficAnalytics Stream Analytics job** blade, under **Job topology**, click **Inputs**, click **+ Add stream input**, and then click **Event Hub**.
4. On the **Event Hub New input** blade, enter the following details, and then click **Save**:
    - **Input alias**: CameraDataFeed3
    - **Select Event Hub from your subscriptions**: selected
    - **Event Hub namespace**: camerafeeds&lt;_your name_&gt;&lt;_date_&gt;
    - **Event Hub name**: Use existing, and select traffic
    - **Event Hub policy name**: RootManageSharedAccessKey
    - **Event Hub consumer group**: cameradatafeed3
5. Wait until the input has been successfully created before continuing with the lab.
6. On the **TrafficAnalytics - Inputs** blade, under **Job topology**, click **Outputs**, click **+ Add**, and then click **Service Bus queue**.
7. On the **New output** blade, enter the following details, and then click **Save**:
    - **Output alias**: SpeedCameraAlerts
    - **Select queue from your subscriptions**: selected
    - **Service Bus namespace**: locationalerts&lt;_your name_&gt;&lt;_date_&gt;
    - **Queue name**: Use existing, and select speedcameraalerts
    - **Queue policy name**: RootManageSharedAccessKey
8. Wait until the output has been successfully created before continuing with the lab.
9. On the **TrafficAnalytics - Outputs** blade, under **Job topology**, click **Functions**, click **+ Add**, and then click **JavaScript UDF**.
10. On the **New function** blade, in the **Function Alias** box, type **IsSpeeding**, and leave the **Output Type** set to **any**.
11. Replace the template function with the following code, and then click **Save**:

    ```JavaScript
    // UDF that returns an integer value indicating whether a vehicle is speeding
    function main(speedLimit, speed) {
      return (speed > speedLimit) ? 1 : 0;
    }
    ```

    You can copy this code from the file **E:\\Labfiles\\Lab03\\UDF1.txt**.

12. On the **TrafficAnalytics - Functions** blade, under **Job topology**, click **Query**, and then add the following statement to the end of the existing query. This new query sends information about speeding cars to the speed camera message queue:

    ```SQL
    SELECT
      CameraID,LocationLatitude,LocationLongitude,SpeedLimit,VehicleRegistration,Speed
    INTO
      SpeedCameraAlerts
    FROM
      CameraDataFeed3
    WHERE
      UDF.IsSpeeding(SpeedLimit, Speed) = 1
    ```

    You copy this query from the file **E:\\Labfiles\\Lab03\\ASAquery1.txt**.

13. Click **Save**, and then click **Yes**.
14. On the **TrafficAnalytics - Query** blade, under **Configure**, click **Scale**.
15. On the **TrafficAnalytics - Scale** blade, if not already set, drag the slider to **12**, click **Save**, and then click **Yes**.

### Task 5: Start the Stream Analytics jobs

1. On the **TrafficAnalytics - Scale** blade, click **Overview**, and then click **Start**.
2. On the **Start job** blade, click **Now**, and then click **Start**.
3. Click **All resources**, and then click the **PatrolCarAnalytics** job.
4. On the **PatrolCarAnalytics** blade, click **Start**.
5. On the **Start job** blade, click **Now**, and then click **Start**.
6. Wait until both jobs have been successfully started before continuing with the lab.

### Task 6: Start the Speed Camera app

1. Click **All resources**, and then click **camerafeeds&lt;_your name_&gt;&lt;_date_&gt;**.
2. On the **camerafeeds&lt;_your name_&gt;&lt;_date_&gt; Event Hubs Namespace** blade, under **Settings**, click **Shared Access Policies**.
3. ON the **camerafeeds&lt;_your name_&gt;&lt;_date_&gt; - Shared access policies** blade, click the **RootManageSharedAccessKey** policy.
4. On the **SAS Policy: RootManageSharedAccessKey** blade, copy the **Primary key** value to the clipboard, and paste it into the **E:\\Labfiles\\Lab03\\Config\_details.txt** file currently open in Notepad.
5. Return to Visual Studio.
6. On the **File** menu, click **Open**, and then click **Project / Solution**.
7. In the **Open Project** dialog box, go to the **E:\\Labfiles\\Lab03\\SpeedCameraDevice** folder, click **SpeedCameraDevice.sln**, and then click **Open**.
8. In Solution Explorer, double-click the **App.config** file.
9. In the App.config file, in the **appSettings** section, in the **ServiceBusConnectionString** key, replace the text **YourNamespace** with **camerafeeds&lt;_your name_&gt;&lt;_date_&gt;**, and replace **YourPrimaryKey** with the event hub primary key that you copied to **Config\_details.txt** file earlier.
10. In Solution Explorer, right-click **SpeedCameraDriver**, and then click **Set as StartUp Project**.
11. On the **Build** menu, click **Build Solution**.
12. Verify that the app compiles successfully, and then click **Start**. The app opens a console window displaying generated speed camera data that is being sent to the event hub.

### Task 7: Start the Patrol Car app

1. In the Azure portal, click **ALl resources**, and then click **patrolcars&lt;_your name_&gt;&lt;_date_&gt;**.
2. On the **patrolcars&lt;_your name_&gt;&lt;_date_&gt; IoT Hub** blade, under **Settings**, click **Shared access policies**.
3. On the **patrolcars&lt;_your name_&gt;&lt;_date_&gt; - Shared acces policies IoT Hub** blade, click **iothubowner**.
4. On the **iothubowner patrolcars&lt;_your name_&gt;&lt;_date_&gt;** blade, copy the **Primary key** value to the clipboard, and paset it into the **E:\\Labfiles\\Lab03\\Config\_details.txt** file.
5. On the Widows **Start** menu, type **Visual Studio 2017**, and then press Enter, to start another instance of Visual Studio.
6. On the **File** menu, click **Open**, and then click **Project / Solution**.
7. In the **Open Project** dialog box, go to the **E:\\Labfiles\\Lab03\\PatrolCarDevice** folder, click **PatrolCarDevice.sln**, and then click **Open**.
8. In Solution Explorer, double-click the **App.config** file.
9. In the App.config file, in the **appSettings** section, in the **ServiceBusConnectionString** key, replace the text **YourServiceBusName** with **locationalerts&lt;_your name_&gt;&lt;_date_&gt;**, and replace **YourServiceBusPrimaryKey** with the primary key for the **locationalerts&lt;_your name_&gt;&lt;_date_&gt;** Service Bus namespace that you copied to **Config\_details.txt** in Task 2.
10. Also in the App.config file, in the **IoTHubConnectionString** and **IotHubUri** keys, replace  the text **YourIoTHub** with **patrolcars&lt;_your name_&gt;&lt;_date_&gt;**.
11. In the **IoTHubConnectionString** key, replace the SharedAccessKey value **YourIoTHubPrimaryKey** with the SharedAccessKey from the IoT Hub connection string you copied to **Config\_details.txt**.
12. On the **Build** menu, click **Build Solution**.
13. Verify that the app compiles successfully, and then click **Start**. The app opens a console window displaying the generated positions of patrol cars that are being sent to the IoT Hub.

### Task 8: Start the Location Alerts app

1. On the Windows **Start** menu, click the **LocationAlerts** app.
2. Verify that the app displays a map (of London), and starts to show cameras with and the speeds of any speeding vehicles, together the positions of dispatched patrol cars.

    >**Note**: it may take a couple of minutes before the map appears and starts displaying the locations of patrol cars and cameras.

### Task 9: View the results

1. Let the system run for a few minutes, to give it time to detect some speeding vehicles, and then observe the fun!
2. Note that the PatrolCarDevice project reports messages when a patrol car is dispatched to chase a speeding vehicle. You should also see the location of the patrol car change to move to the location reported for the speeding vehicle in the LocationAlerts app.

### Task 10: Close jobs and apps

1. Switch to the Azure portal.
2. On the **PatrolCarAnalytics** blade, click **Overview**, click **Stop**, and then click **Yes**.
3. Click **All resources**, and then click **TrafficAnalytics**.
4. On the **TrafficAnalytics** blade, click **Overview**, click **Stop**, and then click **Yes**.
5. On the **TrafficAnalytics** blade, under **Configure**, click **Scale**.
6. On the **TrafficAnalytics - Scale** blade, drag the slider to **1**, click **Save**, and then click **Yes**.
7. Close the Visual Studio map window, to stop the LocationAlerts app.
8. In the **Visual Studio app** window for PatrolCar, press Enter to stop the app.
9. In the **Visual Studio app** window for SpeedCameraDevice, press Enter to stop the app.
10. Close all the instances of Visual Studio.

>**Result**: In this exercise, you:
    - Added a new consumer group to your event hub, 
    - Added a new queue to your Service Bus, 
    - Reconfigured an existing Stream Analytics job to use these resources,
    - Added a UDF that returns an integer value indicating whether a vehicle is speeding,
    - Tested this logic.

## Exercise 2: Use a Stream Analytics UDF to identify duplicate data records

### Task 1: Update the event hub and add a consumer group

1. In the Azure portal, click **All resources**, and then click **camerafeeds&lt;_your name_&gt;&lt;_date_&gt;**.
2. On the **camerafeeds&lt;_your name_&gt;&lt;_date_&gt;** blade, under **Entities**, click **Event Hubs**, and then click **traffic**.
3. On the **traffic** blade, click **+ Consumer group**.
4. On the **Create consumer group** blade, in the **Name** box, type **vehiclefeed**, and then click **Create**.

### Task 2: Create and configure a new Stream Analytics job

1. In the Azure portal, click **+ Create a resource**, click **Analytics**, and then click **Stream Analytics job**.
2. On the **New Stream Analytics Job** blade, in the **Job name** box, enter the following details, and then click **Create**:
    - **Job name**: RegistrationAnalytics
    - **Resource group**:  Use existing, and  select CamerasRG.
    - **Location**: select the same location that you used for the Data Lake Store
    - **Streaming units**: 3
3. Wait until the Stream Analytics job has deployed before continuing with the lab.
4. In the Azure portal, click **All resources**, and then click **RegistrationAnalytics**.
5. On the **RegistrationAnalytics** blade, under **Job topology**, click **Outputs**, click **+ Add**, and then click **Data Lake Store**.
6. On the **Data Lake Store New output** blade, enter the following details, and then click **Save**:
    - **Output alias**: DuplicateVehicles
    - **Select Data Lake Store from your subscriptions**: selected
    - **Account name**: adls&lt;_your name_&gt;&lt;_date_&gt;
    - **Path prefix pattern**: Duplicates/{date}/{time}
    - Click **Authorize**
7. Wait until the output has been successfully created before continuing with the lab.
8. On the **RegistrationAnalytics - Outputs** blade, under **Job topology**, click **Inputs**, click **+ Add stream input**, and then click **Event Hub**.
9. On the **New input** blade, enter the following details, and then click **Save**:
    - **Input alias**: VehicleFeed
    - **Select Event Hub from your subscriptions**: selected
    - **Event Hub namespace**: camerafeeds&lt;_your name_&gt;&lt;_date_&gt;
    - **Event Hub name**: Use existing, and select traffic
    - **Event Hub consumer group**: vehiclefeed
10. Wait until the input has been successfully created before continuing with the lab.
11. On the **RegistrationAnalytics - Inputs** blade, under **Job topology**, click **Functions**, click **+ Add**, and then click **JavaScript UDF**.
12. On the **New function** blade, in the **Function Alias** box, type **DuplicatedVehicle**.
13. Replace the template function code text with the code from the file **E:\\Labfiles\\Lab03\\UDF2.txt**.
14. Click **Save**.
15. On the **RegistrationAnalytics - Functions** blade, under **Job topology**, click **Query**.
16. On the **RegistrationAnalytics - Query** blade, replace the template query text with the following statement, to send information about vehicles with duplicate registration numbers to the Data Lake Store:

    ```SQL
    SELECT
      UDF.DuplicatedVehicle(Collect())
    INTO
      DuplicateVehicles
    FROM
      VehicleFeed
    GROUP BY
      TumblingWindow(minute, 2)
    ```

You can copy this query from the file **E:\\Labfiles\\Lab03\\ASAquery2.txt**.

17. Click **Save**, and then click **Yes**.
18. On the **RegistrationAnalytics - Query** blade, click **Overview**, and then click **Start**.
19. On the **Start job** blade, click **Now**, and then click **Start**.
20. Wait until the job has been successfully started before continuing with the lab.

### Task 3: Start the Speed Camera app

1. On the WIndows **Start** menu, type **Visual Studio 2017**, and then press Enter.
2. On the **File**  menu, click **Open**, and then click **Project / Solution**.
3. In the **Open Project** dialog box, go to the **E:\\Labfiles\\Lab03\\SpeedCameraDevice2** folder, click **SpeedCameraDevice.sln**, and then click **Open**.
4. In Solution Explorer, double-click **App.config**.
5. In the App.config file, in the **appSettings** section, in the **ServiceBusConnectionString** key, replace **YourNamespace** with **camerafeeds&lt;_your name_&gt;&lt;_date_&gt;**, and replace **YourPrimaryKey** with the event hub primary key you copied to **Config\_details.txt** in Exercise 1.
6. In Solution Explorer, right-click **SpeedCameraDriver**, and then click **Set as StartUp Project**.
7. On the **Build** menu, click **Build Solution**.
8. Verify that the app compiles successfully, and then click **Start**. The app opens a console window displaying generated speed camera data that is being sent to the event hub.

### Task 4: Examine the generated data

1. In the Azure portal, click **All resources**, and then click **adls&lt;_your name_&gt;&lt;_date_&gt;**.
2. On the **adls*&lt;your name&gt;&lt;date&gt; ***blade, click **Data Explorer**.
3. In the Data Explorer, expand **Duplicates**, and then click through all the subfolders.
4. Click the JSON file to view the contents in the **File Preview** blade. Note that the data includes duplicate registration numbers, and the locations at which they have been detected.
5. Close the **File Preview** blade.

### Task 5: Close jobs and apps

1. Click **All resources**, and then click **RegistrationAnalytics**.
2. On the **RegistrationAnalytics** blade, click **Stop**, and then click **Yes**.
3. Switch to the Visual Studio app window (where the data is being generated), and press Enter to stop the app.
4. Close Visual Studio.

>**Result**: In this exercise, you added a new consumer group to your event hub, and created a new Stream Analytics job that uses a UDF to identify duplicate vehicle registrations. You tested this logic using a Visual Studio app.

## Exercise 3: Use Machine Learning with Stream Analytics to identify data anomalies

### Task 1: Update the event hub and add another consumer group

1. Click **All resources**, and then click **camerafeeds&lt;_your name_&gt;&lt;_date_&gt;**.
2. On the **camerafeeds&lt;_your name_&gt;&lt;_date_&gt;** blade, under **Entities**, click **Event Hubs**, and then click **traffic**.
3. On the **traffic** blade, click **+ Consumer group**.
4. On the **Create consumer group** blade, in the **Name** box, type **cameradatafeed4**, and then click **Create**.

### Task 2: Create and configure a new Stream Analytics job

1. In the Azure portal, click **+ Create a resource**, click **Analytics**, and then click **Stream Analytics job**.
2. On the **New Stream Analytics Job** blade, enter the following details, and then click **Create**:
    - **Job name**: CaptureTrafficData
    - **Resource group**: Use existing, and select CamerasRG
    - **Location**: select the same location as you used for the Data Lake Store
    - **Streaming units**: 3
3. Wait until the Stream Analytics job has deployed before continuing with the lab.
4. In the Azure portal, click **All resources**, and then click **CaptureTrafficData**.
5. On the **CaptureTrafficData** blade, under **Job Topology**, click **Inputs**, click **+ Add stream input**, and then click **Event Hub**.
6. On the **Event Hub New input** blade, enter the following details, and then click **Save**:
    - **Input alias**: CameraDataFeed4
    - **Select Event Hub from your subscriptions**: selected
    - **Event Hub namespace**: camerafeeds&lt;_your name_&gt;&lt;_date_&gt;
    - **Event Hub name**: Use existing, and select traffic
    - **Event hub consumer group**: cameradatafeed4
7. Wait until the input has been successfully created before continuing with the lab.
8. On the **CaptureTrafficData - Inputs** blade, under **Job topology**, click **Outputs**, click **+ Add**, and then click **Data Lake Store**
9. On the **Data Lake Store New output** blade, enter the following details, and then click **Save**:
    - **Output alias**: TrafficData
    - **Select Data Lake Store from your subscriptions**: selected
    - **Account name**: adls&lt;_your name_&gt;&lt;_date_&gt;
    - **Path prefix pattern**: TrafficTrainingData/
    - **Event serialization format**: CSV
    - Click **Authorize**
10. Wait until the output has been successfully created before continuing with the lab.
11. On the **CaptureTrafficData - Outputs** blade, under **Job topology**, click **Query**.
12. On the **CaptureTrafficData - Query** blade, replace the template query text with the following:

    ```SQL
    SELECT
      CameraID,Speed,DATEPART(hour, Time)
    AS
      HourOfDay
    INTO
      TrafficData
    FROM
      CameraDataFeed4
    ```
You can copy the this query from the file **E:\\Labfiles\\Lab03\\ASAquery3.txt**.

13. Click **Save**, and then click **Yes**.
14. On the **CaptureTrafficData - Query** blade, click **Overview**, and then click **Start**.
15. On the **Start job** blade, click **Now**, and then click **Start**.
16. Wait until the job has been successfully started before continuing with the lab.

### Task 3: Configure and start the Speed Camera app

1. On the Start menu, type **Visual Studio 2017**, and then press Enter.
2. On the **File** page, click **Open**, and then click **Project / Solution**.
3. In the **Open Project** dialog box, go to the **E:\\Labfiles\\Lab03\\SpeedCameraDevice3** folder, click **SpeedCameraDevice.sln**, and then click **Open**.
4. In Solution Explorer, double-click **App.config**.
5. In the App.config file, in the **appSettings** section, in the **ServiceBusConnectionString** key, replace **YourNamespace** with **camerafeeds&lt;_your name_&gt;&lt;_date_&gt;**, and replace **YourPrimaryKey** with the event hub primary key you copied to Config\_details.txt in Exercise 1.
6. In Solution Explorer, right-click **SpeedCameraDriver**, and then click **Set as StartUp Project**.
7. On the **Build** menu, click **Build Solution**.
8. Verify that the app compiles successfully, and then click **Start**.
9. Let the app run for at least five minutes.

### Task 4: Stop the Speed Camera app and the CaptureTrafficData Stream Analytics job

1. In the **SpeedCameraDevice** app window, press Enter to stop the app.
2. In the Azure portal, on the **CaptureTrafficData** blade, click **Stop**, and click **Yes**.
3. Click **All resources**, and then click **adls&lt;_your name_&gt;&lt;_date_&gt;**.
4. On the **adls&lt;_your name_&gt;&lt;_date_&gt;** blade, click **Data Explorer**.
5. In Data Explorer, click **TrafficTrainingData**, and then click the CSV file to view the contents in the **File Preview** blade. Verify that the data includes the speed camera name, recorded traffic speed, and time from your Stream Analytics query, and then close the **File Preview** blade.

    > **Note**: The Speed Camera file also generates the file **E:\\Labfiles\\Lab03\\CameraData.csv** on the virtual machine. This file contains the locations of the cameras used by the training run. For consistency, when you run the app in "non-training" mode, it will read these same locations for the speed cameras. If you run the app in training mode again, make sure that you delete this file first, otherwise you will get duplicate speed cameras—but at different locations.

### Task 5: Download the training data

1. In Data Explorer, click **Download**.
2. In the **Download** pane, click **Start Download now**.
3. In the Internet Explorer message box, click the **Save** drop-down arrow, and then click **Save as**.
4. In the **Save As** dialog box, go to **E:\\Labfiles\\Lab03**, and in the **File name** box, type **TrafficData**, and click **Save**.
5. In the Internet Explorer message box, click **Open**, to view the data in Excel.
6. Verify that the downloaded file contains data on speed camera name, recorded traffic speed, and time, and then close **Excel**.
7. In the Azure portal, close the **Download** blade.

### Task 6: Create a Machine Learning workspace

1. In the Azure portal, click **+ Create a resource**.
2. In the **Search the Marketplace** box, type **Machine Learning Workspace**, and then press Enter.
3. On the **Everything** blade, click **Machine Learning Studio Workspace**.
4. On the **Machine Learning Studio Workspace** blade, click **Create**.
5. On the **Machine Learning Studio Workspace** blade, enter the following details, and then click **Create**:
    - **Workspace name**: Traffic
    - **Resource group**: Use existing, and  select CamerasRG
    - **Location**: Select the nearest location to the one you used for the Data Lake Store.
    - **Storage account**: Create new, and then in the box, type **traffic&lt;_your name_&gt;&lt;_date_&gt;**
    - **Workspace pricing tier**: Standard
    - **Web service plan**: Create new, and accept the default name
    - Click **Web service plan pricing tier**, click **DEVTEST Standard**, and then click **Select**.
6. Wait until the workspace has been deployed before continuing.

### Task 7: Create a machine learning experiment

1. Click **All resources**, and then click **Traffic**.
2. On the **Traffic** blade, under **Additional Links**, click **Launch Machine Learning Studio**.
3. On the **Microsoft Azure Machine Learning Studio** page, click **Sign in**.
4. If prompted, sign in using your Azure account credentials.
5. On the **experiments** page, click **+ NEW**, click **DATASET**, and then click **FROM LOCAL FILE**.
6. In the **Upload a new dataset** dialog box, click **choose file**.
7. In the **Choose file to upload** dialog box, go to **E:\\Labfiles\\Lab03**, click **TrafficData.csv**, and then click **Open**.
8. In the **Upload a new dataset** dialog box, in the **SELECT A TYPE FOR THE NEW DATASET** list, click **Generic CSV File with a header (.csv)**, and then click **Ok** (the tick icon).
9. On the **experiments** page, click **+ NEW**, click **EXPERIMENT**, and then click **Blank Experiment**.
10. In the **Datasets and Modules** list, expand **Saved Datasets**, and then expand **My Datasets**.
11. Drag **TrafficData.csv** to the workspace canvas.
12. In the **Search experiment items** box, type **Split**, and then from the module list, drag **Split Data** to the experiment canvas, below the dataset.
13. Connect **Split Data** to **TrafficData.csv**; to do this, click **TrafficData.csv**, and the output node will show the number 1. Click the output node and, keeping the mouse pressed down, draw a line from the dataset module to the upper input port of the **Split Data** module.
14. Click the **Split Data** module.
15. In the **Properties** pane, in the **Fraction of rows in the first output dataset** box, type **0.7**.
16. In the **Search experiment items** box, type **Train Anomaly**, and then from the module list, drag **Train Anomaly Detection Model** to the experiment canvas, below the **Split Data** module.
17. Connect the leftmost output of the **Split Data** module to the upper right input port of the **Train Anomaly Detection Model** module (this is the Dataset input).
18. In the **Search experiment items** box, type **One-Class**, and then from the module list, drag **One-Class Support Vector Machine** to the experiment canvas, to the left of the **Split Data** module.
19. Connect the output of the **One-Class Support Vector Machine Model** module to the upper left input port of the **Train Anomaly Detection Model** module (this is the untrained model input).
20. In the **Search experiment items** box, type **Score**, and then from the module list, drag **Score Model** to the experiment canvas, below the **Train Anomaly Detection Model** module.
21. Connect the output of the **Train Anomaly Detection Model** module to the leftmost input of the **Score Model** module (this is the trained model input).
22. Connect the rightmost output of the **Split Data** module to the rightmost input of the **Score Model** module (this is the Dataset input).
23. In the toolbar, click **SAVE**, and then click **RUN**.
24. When the experiment has finished running, all modules will show a green check mark to indicate that they have completed successfully.

### Task 8: Create a trained model

1. Right-click the **Train Anomaly Detection Model** module, point to **Trained model**, and then click **Save as Trained Model**.
2. In the **Save trained model** dialog box, in the **Enter a name for the new trained model** box, type **Trained TrafficSpeeds**, and then click **Ok** (the tick icon).
3. Right-click the **One-Class Support Vector Machine** module, then click **Delete**.
4. Right-click the **Train Anomaly Detection Model** module, then click **Delete**.
5. In the **Search experiment items** box, type **Trained**, and then from the module list, drag **Trained TrafficSpeeds** to the experiment canvas, to the left of the **Split Data** module.
6. Connect the output of the **Trained TrafficSpeeds** module to the leftmost input of the **Score Model** module.

### Task 9: Expose the trained model as a web service

1. In the toolbar, click **SET UP WEB SERVICE**.
2. If the **STEP 1** dialog box appears, click **X**.
3. Right-click the connection from the **Web service input** module to the **Split Data** module, and then click **Delete**.
4. Connect the output of the **Web service input** module to the rightmost input of the **Score Model** module.
5. In the toolbar, click **SAVE**, and then click **RUN** (to validate the changes).
6. When the experiment has finished running, all modules will show a green check mark to indicate that they have successfully finished.
7. In the toolbar, click **DEPLOY WEB SERVICE**, and then click **Deploy Web Service [Classic]**.
8. Copy the **API key**, to the **E:\\Labfiles\\Lab03\\Config\_details.txt** file (this file should still be open in Notepad).
9. In Microsoft Azure Machine Learning Studio, on the **experiment created on *&lt;date&gt;*** page, click **New Web Services Experience**.
10. On the **Experiment created on *&lt;date&gt;*** page, under **BASICS**, click **Configure endpoint**.
11. In the **Description** box, type **Traffic speed anomaly detection web service**, and then click **Save**.
12. In the toolbar, click **Quickstart**, and then click **Use endpoint**.
13. Copy the **Request-Response** URL to the **E:\\Labfiles\\Lab03\\Config\_details.txt** file.

### Task 10: Add another consumer group to the Speed Camera event hub

1. Switch to the Azure portal.
2. Click **All resources**, and then click **camerafeeds&lt;_your name_&gt;&lt;_date_&gt;**.
3. On the **camerafeeds&lt;_your name_&gt;&lt;_date_&gt;** blade, under **Entities**, click **Event Hubs**, and then click **traffic**.
4. On the **traffic** blade, click **+ Consumer group**.
5. On the **Create consumer group** blade, in the **Name** box, type **cameraspeedanomalyfeed**, and then click **Create**.

### Task 11: Create a new Service Bus queue

1. Click **All resources**, and then click **locationalerts&lt;_your name_&gt;&lt;_date_&gt;**.
2. On the **locationalerts*&lt;your name&gt;&lt;date&gt;** blade, under **Entities**, click **Queues**.
3. On the **Queues** blade, click **+ Queue**.
4. On the **Create queue** blade, in the **Name** box, type **TrafficJamAlerts**.
5. Leave all other settings at their defaults, and then click **Create**.
6. Wait until the queue has been successfully created before continuing with the lab.

### Task 12: Create and Configure a new Stream Analytics job

1. Switch to the Azure portal, click **+ Create a resource**, click **Analytics**, and then click **Stream Analytics job**.
2. On the **New Stream Analytics Job** blade, enter the following details, and then click **Create**:
    - **Job name**: DetectSpeedAnomalies.
    - **Resource group**: Use existing, and select CamerasRG.
    - **Location**: select the same location that you used for the Data Lake Store
    - **Streaming units**: 12
3. Wait until the Stream Analytics job has deployed before continuing with the lab.
4. Click **All resources**, and then click **DetectSpeedAnomalies**.
5. On the **DetectSpeedAnomalies - Stream Analytics job** blade, under **Job Topology**, click **Inputs**, click **+ Add stream input**, and then click **Event, Hub**.
6. In the **Event Hub New input** blade, enter the following details, and then click **Save**:
    - **Input alias**: SpeedCameraData
    - **Select Event Hub from your subscriptions**: selected
    - **Event Hub namespace**: camerafeeds&lt;_your name_&gt;&lt;_date_&gt;
    - **Event Hub name**: Use existing, and select traffic
    - **Event hub consumer group**: cameraspeedanomalyfeed
7. Wait until the input has been successfully created before continuing with the lab.
8. On the **CaptureTrafficData - Inputs** blade, under **Job Topology**, click **Outputs**, click **+ Add**, and then click **Data Lake Store**
9. On the **Data Lake Store New output** blade, enter the following details, and then click **Save**:
    - **Output alias**: TrafficData
    - **Select Data Lake Store from your subscriptions**: selected
    - **Account name**: adls&lt;_your name_&gt;&lt;_date_&gt;
    - **Path prefix pattern**: SpeedAnomalyData/
    - **Event serialization format**: JSON
    - Click **Authorize**
10. Wait until the output has been successfully created before continuing with the lab.
11. On the **DetectSpeedAnomalies - Outputs** blade, under **Job Topology**, click **Functions**, and, click **+ Add**, and then click **Azure ML**.
12. On the **New function** blade, enter the following details and then click **Save**:
    - **Function Alias**: SpeedAnomaly
    - **Provide Azure Machine Learning function settings manually**: selected
    - **URL**: The Request-Response URL that you copied to the **Config\_details.txt** file.
    - **Key**: The web service API key that you copied to the **Config\_details.txt** file.
13. On the **DetectSpeedAnomalies - Functions** blade, under **Job Topology**, click **Outputs**, click **+ Add**, and then **Service Bus queue**.
14. On the **Service Bus queue New output** blade, enter the following details, and then click **Save**:
    - **Output alias**: TrafficJamAlerts
    - **Select queue from your subscriptions**: selected
    - **Service Bus namespace**: locationalerts&lt;_your name_&gt;&lt;_date_&gt;
    - **Queue name**: trafficjamalerts
15. Wait until the output has been successfully created before continuing with the lab.
16. On the **DetectSpeedAnomalies - Outputs** blade, under **Job Topology**, click **Query**, and then replace the template query text with the following:

    ```SQL
     WITH
      SpeedAnomalies
    AS
      (SELECT 
        CameraID,
        AVG(Speed) AS AvgSpeed, 
        SpeedAnomaly(CameraID, AVG(Speed), DATEPART(hour, MAX(Time))) AS Results, 
        DATEPART(hour, MAX(Time)) AS HourOfDay
      FROM
        SpeedCameraData
      TIMESTAMP BY
        Time
      GROUP BY
        CameraID, TumblingWindow(minute, 2))

    SELECT
      CameraID, AvgSpeed, HourOfDay
    INTO
      TrafficData
    FROM
      SpeedAnomalies
    WHERE
      Results.[Scored Labels] = '1'

    SELECT
      CameraID, AvgSpeed
    INTO
      TrafficJamAlerts
    FROM
      SpeedAnomalies
    WHERE
      Results.[Scored Labels] = '1'
    ```

You can copy these commands from the file **E:\\Labfiles\\Lab03\\ASAquery4.txt**.

17. Click **Save**, and then click **Yes**.

### Task 13: Start the Stream Analytics jobs

1. On the **DetectSpeedAnomalies - Query** blade, click **Overview**, and then click **Start**.
2. On the **Start job** blade, click **Now**, and then click **Start**.
3. Wait until the job has been successfully started before continuing with the lab.
4. Click **All resources**, and then click **TrafficAnalytics**.
5. On the **TrafficAnalytics** blade, click **Start**.
6. On the **Start job** blade, click **Now**, and then click **Start**.
7. Wait until the job has been successfully started before continuing with the lab.
8. Click **All resources**, and then click **PatrolCarAnalytics**.
9. On the **PatrolCarAnalytics** blade, click **Start**.
10. On the **Start job** blade, click **Now**, and then click **Start**.
11. Wait until the job has been successfully started before continuing with the lab.

### Task 14l: Configure the Location Alerts app

1. On the Windows **Start** menu, type **Visual Studio 2017**, and then press Enter to start a second instance of Visual Studio.
2. On the **File** menu, click **Open**, and then click **Project / Solution**.
3. In the **Open Project** dialog box, go to the **E:\\Labfiles\\Lab03\\LocationAlerts2** folder, click **LocationAlerts.sln**, and then click **Open**.
4. In Solution Explorer, double-click **ConfigSettings.txt**.
5. In the ConfigSettings.txt file, replace **YourServiceBusName** with **locationalerts&lt;_your name_&gt;&lt;_date_&gt;**.
6. In ConfigSettings.txt, replace **YourPrimaryKey** with the SharedAccessKey for the Service Bus that you copied to **Config\_details.txt** in Exercise 1.
7. On the **Build** menu, click **Build Solution**. Verify that the app compiles successfully.
8. On the **Build** menu, click **Deploy Solution**. Do not start the app.

### Task 15: Start the Patrol Car and Speed Camera apps

1. In Visual Studio, on the **File** menu, click **Open**, and then click **Project / Solution**.
2. In the **Open Project** dialog box, go to the **E:\\Labfiles\\Lab03\\PatrolCarDevice** folder, click **PatrolCarDevice.sln**, and then click **Open**. This is the same app that you ran in Exercise 1; it should already be configured correctly.
3. Click **Start**. Verify that the app opens a console window displaying the generated positions of patrol cars that are being sent to the IoT Hub.
4. Switch to the **SpeedCameraDevice** instance of Visual Studio.
5. In App.config, in the **appSettings** section, in the **TrainingRun** key, replace **true** with **false**.
6. On the **Build** menu, click **Build Solution**. Verify that the app compiles successfully.
7. Click **Start**. The app opens a console window displaying generated speed camera data that is being sent to the event hub.

### Task 16: Start the Location Alerts app and view the results

1. On the Windows **Start** menu, type **LocationAlerts**, and then click the **LocationAlerts** app to start it running.  Verify that the app displays a map (of London), and starts to show the positions of speeding anomalies, the positions of dispatched patrol cars, and traffic blockage alert messages where traffic is not moving (speeds = 0 mph).

>**Note**: It will take up to two minutes before any alert messages start to appear. Thereafter, messages will appear in batches approximately every two minutes. This is because the query used by the **DetectSpeedAnomalies** job aggregates data across a two-minute time window. 

### Task 17: Lab closedown

1. Switch to the Azure portal, on the **PatrolCarAnalytics** blade, click **Stop**, and click **Yes**.
2. Click **All resources**, and then click **TrafficAnalytics**.
3. On the **TrafficAnalytics** blade, click **Stop**, and then click **Yes**.
4. Click **All resources**, and then click **DetectSpeedAnomalies**.
5. On the **DetectSpeedAnomalies** blade, click **Stop**, and click **Yes**.
6. On the **DetectSpeedAnomalies** blade, under **Configure**, click **Scale**.
7. On the **DetectSpeedAnomalies** **- Scale** blade, drag the slider to **1**, click **Save**, and then click **Yes**.
8. Close the Visual Studio map window, to stop the **LocationAlerts** app.
9. In the Visual Studio app window for **PatrolCarDevice**, press Enter to stop the app.
10. In the Visual Studio app window for **SpeedCameraDevice**, press Enter to stop the app.
11. Close all the instances of Visual Studio.
12. Do not remove the Azure resources (resource group, Stream Analytics jobs, event hub, IoT hub, and storage); these resources will be used in later labs.
13. Close Internet Explorer.

>**Result**: In this exercise, you added new consumer groups to your event hub, and created a new Stream Analytics job that works with a Visual Studio app to generate training data. You created a machine learning experiment to detect anomalous data, train your model using the generated training data, and then deployed the trained model as a web service. You created another Stream Analytics job that uses the Machine Learning web service to detect anomalies in data in the input stream.

---

©2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.
